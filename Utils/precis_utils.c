/*
 * Unicode-Precis
 *
 * Copyright (C) 2015, 2018 by Hatuka*nezumi - IKEDA Soji
 *
 * This library is free software; you can redistribute it and/or modify it
 * under the same terms as Perl itself. For more details, see the full text of
 * the licenses at <http://dev.perl.org/licenses/>.
 *
 * This program is distributed in the hope that it will be
 * useful, but without any warranty; without even the implied
 * warranty of merchantability or fitness for a particular purpose.
 */

/* Begin auto-generated maps */

static void *widthdecomp_map_EF_BF[64] = {
    NULL, NULL, "\xE3\x85\x8F", "\xE3\x85\x90", "\xE3\x85\x91",
    "\xE3\x85\x92", "\xE3\x85\x93", "\xE3\x85\x94", NULL, NULL,
    "\xE3\x85\x95", "\xE3\x85\x96", "\xE3\x85\x97", "\xE3\x85\x98",
    "\xE3\x85\x99", "\xE3\x85\x9A", NULL, NULL, "\xE3\x85\x9B",
    "\xE3\x85\x9C", "\xE3\x85\x9D", "\xE3\x85\x9E", "\xE3\x85\x9F",
    "\xE3\x85\xA0", NULL, NULL, "\xE3\x85\xA1", "\xE3\x85\xA2",
    "\xE3\x85\xA3", NULL, NULL, NULL, "\xC2\xA2", "\xC2\xA3", "\xC2\xAC",
    "\xC2\xAF", "\xC2\xA6", "\xC2\xA5", "\xE2\x82\xA9", NULL,
    "\xE2\x94\x82", "\xE2\x86\x90", "\xE2\x86\x91", "\xE2\x86\x92",
    "\xE2\x86\x93", "\xE2\x96\xA0", "\xE2\x97\x8B", NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL
};

static void *widthdecomp_map_EF_BE[64] = {
    "\xE3\x82\xBF", "\xE3\x83\x81", "\xE3\x83\x84", "\xE3\x83\x86",
    "\xE3\x83\x88", "\xE3\x83\x8A", "\xE3\x83\x8B", "\xE3\x83\x8C",
    "\xE3\x83\x8D", "\xE3\x83\x8E", "\xE3\x83\x8F", "\xE3\x83\x92",
    "\xE3\x83\x95", "\xE3\x83\x98", "\xE3\x83\x9B", "\xE3\x83\x9E",
    "\xE3\x83\x9F", "\xE3\x83\xA0", "\xE3\x83\xA1", "\xE3\x83\xA2",
    "\xE3\x83\xA4", "\xE3\x83\xA6", "\xE3\x83\xA8", "\xE3\x83\xA9",
    "\xE3\x83\xAA", "\xE3\x83\xAB", "\xE3\x83\xAC", "\xE3\x83\xAD",
    "\xE3\x83\xAF", "\xE3\x83\xB3", "\xE3\x82\x99", "\xE3\x82\x9A",
    "\xE3\x85\xA4", "\xE3\x84\xB1", "\xE3\x84\xB2", "\xE3\x84\xB3",
    "\xE3\x84\xB4", "\xE3\x84\xB5", "\xE3\x84\xB6", "\xE3\x84\xB7",
    "\xE3\x84\xB8", "\xE3\x84\xB9", "\xE3\x84\xBA", "\xE3\x84\xBB",
    "\xE3\x84\xBC", "\xE3\x84\xBD", "\xE3\x84\xBE", "\xE3\x84\xBF",
    "\xE3\x85\x80", "\xE3\x85\x81", "\xE3\x85\x82", "\xE3\x85\x83",
    "\xE3\x85\x84", "\xE3\x85\x85", "\xE3\x85\x86", "\xE3\x85\x87",
    "\xE3\x85\x88", "\xE3\x85\x89", "\xE3\x85\x8A", "\xE3\x85\x8B",
    "\xE3\x85\x8C", "\xE3\x85\x8D", "\xE3\x85\x8E", NULL
};

static void *widthdecomp_map_EF_BD[64] = {
    "\x60", "\x61", "\x62", "\x63", "\x64", "\x65", "\x66", "\x67", "\x68",
    "\x69", "\x6A", "\x6B", "\x6C", "\x6D", "\x6E", "\x6F", "\x70", "\x71",
    "\x72", "\x73", "\x74", "\x75", "\x76", "\x77", "\x78", "\x79", "\x7A",
    "\x7B", "\x7C", "\x7D", "\x7E", "\xE2\xA6\x85", "\xE2\xA6\x86",
    "\xE3\x80\x82", "\xE3\x80\x8C", "\xE3\x80\x8D", "\xE3\x80\x81",
    "\xE3\x83\xBB", "\xE3\x83\xB2", "\xE3\x82\xA1", "\xE3\x82\xA3",
    "\xE3\x82\xA5", "\xE3\x82\xA7", "\xE3\x82\xA9", "\xE3\x83\xA3",
    "\xE3\x83\xA5", "\xE3\x83\xA7", "\xE3\x83\x83", "\xE3\x83\xBC",
    "\xE3\x82\xA2", "\xE3\x82\xA4", "\xE3\x82\xA6", "\xE3\x82\xA8",
    "\xE3\x82\xAA", "\xE3\x82\xAB", "\xE3\x82\xAD", "\xE3\x82\xAF",
    "\xE3\x82\xB1", "\xE3\x82\xB3", "\xE3\x82\xB5", "\xE3\x82\xB7",
    "\xE3\x82\xB9", "\xE3\x82\xBB", "\xE3\x82\xBD"
};

static void *widthdecomp_map_EF_BC[64] = {
    NULL, "\x21", "\x22", "\x23", "\x24", "\x25", "\x26", "\x27", "\x28",
    "\x29", "\x2A", "\x2B", "\x2C", "\x2D", "\x2E", "\x2F", "\x30", "\x31",
    "\x32", "\x33", "\x34", "\x35", "\x36", "\x37", "\x38", "\x39", "\x3A",
    "\x3B", "\x3C", "\x3D", "\x3E", "\x3F", "\x40", "\x41", "\x42", "\x43",
    "\x44", "\x45", "\x46", "\x47", "\x48", "\x49", "\x4A", "\x4B", "\x4C",
    "\x4D", "\x4E", "\x4F", "\x50", "\x51", "\x52", "\x53", "\x54", "\x55",
    "\x56", "\x57", "\x58", "\x59", "\x5A", "\x5B", "\x5C", "\x5D", "\x5E",
    "\x5F"
};

static void *widthdecomp_map_EF[64] = {
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    widthdecomp_map_EF_BC, widthdecomp_map_EF_BD, widthdecomp_map_EF_BE,
    widthdecomp_map_EF_BF
};

static void *widthdecomp_map_E3_80[64] = {
    "\x20", NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL
};

static void *widthdecomp_map_E3[64] = {
    widthdecomp_map_E3_80, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL
};

static void *widthdecomp_map[64] = {
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    widthdecomp_map_E3, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, widthdecomp_map_EF, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL
};

static void *space_map_E3_80[64] = {
    "\x20", NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL
};

static void *space_map_E3[64] = {
    space_map_E3_80, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL
};

static void *space_map_E2_81[64] = {
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, "\x20", NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL
};

static void *space_map_E2_80[64] = {
    "\x20", "\x20", "\x20", "\x20", "\x20", "\x20", "\x20", "\x20", "\x20",
    "\x20", "\x20", NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, "\x20", NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL
};

static void *space_map_E2[64] = {
    space_map_E2_80, space_map_E2_81, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL
};

static void *space_map_E1_9A[64] = {
    "\x20", NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL
};

static void *space_map_E1[64] = {
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, space_map_E1_9A, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL
};

static void *space_map_C2[64] = {
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, "\x20", NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL
};

static void *space_map[64] = {
    NULL, NULL, space_map_C2, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    space_map_E1, space_map_E2, space_map_E3, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL
};

/* End of auto-generated maps */

static const U8 utf8_sequence_len[0x100] = {
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,	/* 0x00-0x0F */
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,	/* 0x10-0x1F */
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,	/* 0x20-0x2F */
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,	/* 0x30-0x3F */
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,	/* 0x40-0x4F */
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,	/* 0x50-0x5F */
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,	/* 0x60-0x6F */
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,	/* 0x70-0x7F */
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,	/* 0x80-0x8F */
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,	/* 0x90-0x9F */
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,	/* 0xA0-0xAF */
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,	/* 0xB0-0xBF */
    0, 0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2,	/* 0xC0-0xCF */
    2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2,	/* 0xD0-0xDF */
    3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3,	/* 0xE0-0xEF */
    4, 4, 4, 4, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,	/* 0xF0-0xFF */
};

static STRLEN _map(U8 **newptr, U8 * buf, const size_t buflen, int ix)
{
    U8 *new;
    U8 *p, *q;
    U8 *end = buf + buflen;
    U8 *end4 = end - 4;

    STRLEN len, i, mappedlen;
    U32 vec;
    char *mapped;
    void **mapent;
    U8 folded[UTF8_MAXBYTES_CASE + 1];

    if (newptr == NULL)
	return 0;
    new = *newptr;

  redo:
    p = buf;
    q = new;
    while (p < end4) {
      check:
	len = utf8_sequence_len[*p];

	switch (len) {
	case 0:
	    goto garbage;

	case 1:
	    break;

	case 2:
	    /* 110xxxxx 10xxxxxx */
	    if ((p[1] & 0xC0) != 0x80)
		goto garbage;
	    break;

	case 3:
	    vec = ((U32) p[0] << 16)
		| ((U32) p[1] << 8)
		| ((U32) p[2]);
	    /* 1110xxxx 10xxxxxx 10xxxxxx *//* Non-shortest form */
	    if ((vec & 0x00F0C0C0) != 0x00E08080 || vec < 0x00E0A080)
		goto garbage;
	    break;

	case 4:
	    vec = ((U32) p[0] << 24)
		| ((U32) p[1] << 16)
		| ((U32) p[2] << 8)
		| ((U32) p[3]);
	    /* 11110xxx 10xxxxxx 10xxxxxx 10xxxxxx *//* Non-shortest form */
	    if ((vec & 0xF8C0C0C0) != 0xF0808080 || vec < 0xF0908080)
		goto garbage;
	    break;

	  garbage:
	    if (new == NULL)
		q++, p++;
	    else
		*q++ = *p++;
	    continue;		/* while (p < end4) */
	}

	switch (ix) {
	case 1:			/* foldCase */
	    toFOLD_utf8_safe(p, p + len, folded, &mappedlen);
	    if (mappedlen <= 0)
		goto nomap;
	    mapped = (char *)folded;
	    break;

	case 2:			/* mapSpace */
	    if (len == 1)
		goto nomap;

	    mapent = space_map;
	    for (i = 0; i < len; i++) {
		mapent = mapent[p[i] & 0x3F];
		if (mapent == NULL)
		    break;
	    }
	    if (mapent == NULL)
		goto nomap;
	    mapped = "\x20";
	    mappedlen = 1;
	    break;

	case 3:			/* mapWidth */
	    if (len == 1)
		goto nomap;

	    mapent = widthdecomp_map;
	    for (i = 0; i < len; i++) {
		mapent = mapent[p[i] & 0x3F];
		if (mapent == NULL)
		    break;
	    }
	    if (mapent == NULL)
		goto nomap;
	    mapped = (char *)mapent;
	    for (mappedlen = 0; mapped[mappedlen] != '\0'; mappedlen++);
	    break;

	case 4:			/* lowerCase */
	    toLOWER_utf8_safe(p, p + len, folded, &mappedlen);
	    if (mappedlen <= 0)
		goto nomap;
	    mapped = (char *)folded;
	    break;

	default:
	  nomap:
	    mapped = (char *)p;
	    mappedlen = len;
	    break;
	}			/* switch (ix) */

	if (new == NULL)
	    q += mappedlen;
	else
	    for (i = 0; i < mappedlen; i++)
		*q++ = *mapped++;
	p += len;
    }				/* while (p < end4) */
    if (p < end) {
	if (p + utf8_sequence_len[*p] <= end)
	    goto check;

	if (new == NULL)
	    q += end - p;
	else
	    while (p < end)
		*q++ = *p++;
    }

    if (new == NULL) {
	new = malloc(q - new + 1);
	if (new == NULL)
	    return 0;
	goto redo;
    }

    *q = '\0';
    *newptr = new;
    return q - new;
}

